<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>İki Kişilik Sohbet - v9</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #128C7E;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            background-color: #ece5dd;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        h2 {
            background-color: #075E54;
            color: white;
            margin: 0;
            padding: 15px;
            text-align: center;
            font-size: 24px;
        }
        #login, #chat {
            flex: 1;
            display: none;
            flex-direction: column;
            width: 100%;
        }
        #login {
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #login input {
            width: 80%;
            padding: 15px;
            margin: 10px 0;
            font-size: 18px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }
        #login button {
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 10px;
            background-color: #25D366;
            color: white;
            border: none;
        }
        #login p.version {
            margin-top: 20px;
            font-size: 12px;
            color: gray;
        }
        #status {
            font-size: 12px;
            color: gray;
            margin: 5px auto;
            text-align: center;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-image: url('https://www.transparenttextures.com/patterns/white-paper.png');
            background-size: cover;
            display: flex;
            flex-direction: column;
        }
        .message {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 90%;
            word-wrap: break-word;
        }
        .me {
            background-color: #dcf8c6;
            margin-left: auto;
        }
        .other {
            background-color: #f5f5f5;
            margin-right: auto;
        }
        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .text-block {
            display: flex;
            flex-direction: column;
        }
        .time {
            font-size: 10px;
            color: gray;
            margin-top: 3px;
        }
        #inputArea {
            display: flex;
            padding: 10px;
            background-color: #f0f0f0;
            align-items: center;
            position: sticky;
            bottom: 0;
        }
        #messageInput {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            margin: 0 10px;
            resize: none;
            height: 40px;
        }
        #inputArea button {
            padding: 10px 15px;
            background-color: #25D366;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
        }
        @media (max-width: 600px) {
            #container { border-radius: 0; height: 100vh; }
            .message { max-width: 95%; }
        }
    </style>
</head>
<body>

<div id="container">
    <h2>İki Kişilik Sohbet</h2>

    <div id="login">
        <input type="text" id="username" placeholder="Kullanıcı Adı">
        <input type="password" id="password" placeholder="Şifre">
        <button onclick="login()">Giriş Yap</button>
        <p id="loginError" style="color: red; text-align:center;"></p>
        <p class="version">Sürüm: v9</p>
    </div>

    <div id="chat">
        <div id="status"></div>
        <div id="messages"></div>
        <div id="inputArea">
            <button id="emojiBtn"><i class="fa fa-smile"></i></button>
            <textarea id="messageInput" placeholder="Mesaj yaz..."></textarea>
            <button id="sendBtn"><i class="fa fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script type="module">
    import { EmojiButton } from 'https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCPejajCJIhR_STwr6Czm_hGsOLEPng3Bw",
        authDomain: "sohbet-sitesi-2d0d8.firebaseapp.com",
        databaseURL: "https://sohbet-sitesi-2d0d8-default-rtdb.firebaseio.com",
        projectId: "sohbet-sitesi-2d0d8",
        storageBucket: "sohbet-sitesi-2d0d8.appspot.com",
        messagingSenderId: "554862357464",
        appId: "1:554862357464:web:ea1f72b4627147b47460ad"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const validUsers = {
        erenyel: '0507eren2003',
        edayontem: 'eday2003'
    };

    const userAvatars = {
        erenyel: 'eren.png',
        edayontem: 'eda.png'
    };

    let currentUser = '';
    let otherUser = '';

    document.getElementById('login').style.display = 'flex';

    function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();

        if (validUsers[username] && validUsers[username] === password) {
            currentUser = username;
            otherUser = Object.keys(validUsers).find(u => u !== username);

            document.getElementById('login').style.display = 'none';
            document.getElementById('chat').style.display = 'flex';

            db.ref('status/' + currentUser).set({ online: true });
            db.ref('status/' + currentUser).onDisconnect().set({ online: false, lastSeen: new Date().toLocaleString() });

            listenForMessages();
            listenForStatus();
        } else {
            document.getElementById('loginError').innerText = 'Hatalı kullanıcı adı veya şifre!';
        }
    }

    document.getElementById('username').addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(), login(); });
    document.getElementById('password').addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(), login(); });

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (message === '') return;

        db.ref('messages').push({
            user: currentUser,
            text: message,
            timestamp: Date.now()
        });

        input.value = '';
    }

    function listenForMessages() {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';

        db.ref('messages').on('child_added', snapshot => {
            const msg = snapshot.val();
            const msgElement = document.createElement('div');
            msgElement.classList.add('message');
            msgElement.classList.add(msg.user === currentUser ? 'me' : 'other');

            const avatar = document.createElement('img');
            avatar.src = userAvatars[msg.user];
            avatar.className = 'avatar';

            const textBlock = document.createElement('div');
            textBlock.className = 'text-block';

            const textSpan = document.createElement('span');
            textSpan.innerText = msg.text;

            const timeSpan = document.createElement('span');
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            timeSpan.className = 'time';
            timeSpan.innerText = time;

            textBlock.appendChild(textSpan);
            textBlock.appendChild(timeSpan);

            msgElement.appendChild(avatar);
            msgElement.appendChild(textBlock);
            messagesDiv.appendChild(msgElement);

            // Yeni mesajda en alta kaydır
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    }

    function listenForStatus() {
        const statusDiv = document.getElementById('status');
        db.ref('status/' + otherUser).on('value', snapshot => {
            const status = snapshot.val();
            if (status && status.online) {
                statusDiv.innerText = `${otherUser} çevrimiçi`;
            } else if (status && status.lastSeen) {
                statusDiv.innerText = `${otherUser} son görülme: ${status.lastSeen}`;
            } else {
                statusDiv.innerText = `${otherUser} çevrimdışı`;
            }
        });
    }

    const picker = new EmojiButton();
    const emojiBtn = document.querySelector('#emojiBtn');
    emojiBtn.addEventListener('click', () => picker.togglePicker(emojiBtn));
    picker.on('emoji', emoji => {
        document.querySelector('#messageInput').value += emoji;
    });

    document.getElementById('messageInput').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
</script>

</body>
</html>
