<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sohbet Sitesi v14</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Koyu Tema Değerleri */
      --primary-bg: #222937;
      --primary-bg-gradient: linear-gradient(120deg, #222937 0%, #37425a 100%);
      --chat-bg: #151b24;
      --bubble-me: linear-gradient(125deg, #0f8ecf 0%, #2560a7 100%);
      --bubble-other: linear-gradient(120deg, #343e53 0%, #45516a 100%);
      --header: #222937;
      --input-bg: #232a3b;
      --input-border: #3a4258;
      --btn-gradient: linear-gradient(90deg, #329dba 30%, #4569ad 100%);
      --btn-hover: #276b8d;
      --scrollbar-thumb: #394a64;
      --scrollbar-track: #20242e;
      --text-main: #eaf4ff;
      --text-meta: #8aa3c8;
      --text-online: #72e8b5;
      --bubble-shadow: 0 2px 12px #242e3855;
      --theme-switch-bg: #263554;
      --theme-switch-thumb: #62f8ce;
      --theme-switch-thumb-dark: #fff;
      --theme-switch-thumb-light: #222;
      --theme-switch-border: #203040;
    }
    body[data-theme="light"] {
      --primary-bg: #f3f7fa;
      --primary-bg-gradient: linear-gradient(120deg, #e2ecf6 0%, #e9e6ff 100%);
      --chat-bg: #f8fbfd;
      --bubble-me: linear-gradient(125deg, #95e2fa 0%, #d2f8ee 100%);
      --bubble-other: linear-gradient(120deg, #e5eaff 0%, #f5f9ff 100%);
      --header: #f3f7fa;
      --input-bg: #fff;
      --input-border: #cddbef;
      --btn-gradient: linear-gradient(90deg, #7fd8e5 30%, #bbc6fa 100%);
      --btn-hover: #b4c2e9;
      --scrollbar-thumb: #b3cae0;
      --scrollbar-track: #e7edf3;
      --text-main: #223355;
      --text-meta: #5c7da3;
      --text-online: #23b34a;
      --bubble-shadow: 0 2px 12px #c5c9e466;
      --theme-switch-bg: #f0f3fc;
      --theme-switch-thumb: #222;
      --theme-switch-thumb-dark: #222;
      --theme-switch-thumb-light: #fff;
      --theme-switch-border: #bbc6fa;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--primary-bg-gradient);
      font-family: 'Montserrat', sans-serif;
      min-height: 100vh;
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      transition: background 0.6s, color 0.3s;
    }
    .login-container, .chat-container {
      max-width: 420px;
      width: 95vw;
      margin: 32px auto 0 auto;
      background: rgba(34,41,55,0.97);
      background: var(--primary-bg);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(44,72,100,0.24);
      padding: 28px 18px 18px 18px;
      animation: fadeIn .8s;
      transition: background .5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(16px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .login-title {
      font-size: 2rem;
      font-weight: 700;
      color: #84fff9;
      text-align: center;
      margin-bottom: 24px;
      letter-spacing: 1px;
      text-shadow: 0 1px 8px #15294090;
      transition: color .4s;
    }
    body[data-theme="light"] .login-title { color: #369cd4; text-shadow: none; }
    .theme-switch {
      position: absolute;
      top: 16px;
      right: 26px;
      z-index: 20;
      user-select: none;
    }
    .theme-switch input[type="checkbox"] {
      display: none;
    }
    .switch-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      background: var(--theme-switch-bg);
      border: 2px solid var(--theme-switch-border);
      border-radius: 18px;
      width: 54px; height: 28px;
      transition: background .45s;
      box-shadow: 0 2px 8px #0d223055;
      position: relative;
      padding: 2px;
    }
    .switch-thumb {
      height: 22px; width: 22px;
      border-radius: 50%;
      background: var(--theme-switch-thumb);
      position: absolute;
      top: 2px;
      left: 2px;
      transition: left .36s cubic-bezier(.8,1.8,.5,.8), background .45s;
      box-shadow: 0 1px 8px #222c4444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.05rem;
    }
    .switch-icon {
      position: absolute;
      left: 9px;
      top: 6px;
      font-size: 1.18rem;
      opacity: 0.6;
      pointer-events: none;
      transition: color .4s;
    }
    .switch-icon.sun {
      left: 29px;
      color: #f9d23b;
    }
    .switch-icon.moon {
      left: 7px;
      color: #3ed8ec;
    }
    .theme-switch input:checked + .switch-label .switch-thumb {
      left: 30px;
      background: var(--theme-switch-thumb-dark);
    }
    .theme-switch input:not(:checked) + .switch-label .switch-thumb {
      background: var(--theme-switch-thumb-light);
    }
    .login-fields {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .login-fields input {
      padding: 12px 14px;
      border-radius: 9px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 1rem;
      transition: box-shadow .2s, background .4s, color .3s;
      outline: none;
    }
    .login-fields input:focus {
      box-shadow: 0 2px 12px #43c6e4a2;
    }
    .login-btn {
      margin-top: 16px;
      background: var(--btn-gradient);
      color: #fff;
      font-size: 1.13rem;
      font-weight: bold;
      padding: 11px 0;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      letter-spacing: .5px;
      transition: background .2s, transform .1s;
      box-shadow: 0 2px 8px #124e6788;
    }
    .login-btn:hover { background: var(--btn-hover); transform: scale(1.03);}
    .login-error {
      color: #ff5e75;
      text-align: center;
      margin-top: 12px;
      font-size: 1rem;
    }
    /* Chat container styles */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 10px;
      border-bottom: 1px solid #293448;
      background: var(--header);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 2px 8px #151b2417;
      position: relative;
      transition: background .5s;
    }
    .chat-header img {
      width: 42px; height: 42px;
      border-radius: 50%;
      object-fit: cover;
      border: 2.5px solid #74ebd5;
      background: #eee;
      transition: border .3s;
    }
    .user-info-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }
    .status-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.97rem;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-online);
      font-weight: 500;
      min-height: 18px;
      transition: color .5s;
      font-size: 0.97rem;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 3px;
      background: #6cffae;
      box-shadow: 0 1px 4px #55ffa441;
      transition: background .4s;
    }
    .status-item.offline { color: var(--text-meta);}
    .status-item.offline .status-dot { background: #b2c7e5; }
    .status-user {
      font-weight: bold;
      color: var(--text-main);
      margin-right: 7px;
      min-width: 70px;
      transition: color .5s;
      font-size: 0.99rem;
      letter-spacing: .2px;
    }
    .logout-btn, .clear-btn {
      margin-left: 8px;
      padding: 7px 16px;
      font-size: 0.99rem;
      border: none;
      border-radius: 8px;
      background: #1d2535;
      color: #72e8b5;
      cursor: pointer;
      transition: background .2s;
    }
    .logout-btn:hover, .clear-btn:hover { background: #293348; }
    .chat-messages {
      margin: 12px 0;
      height: 380px;
      max-height: 55vh;
      overflow-y: auto;
      background: var(--chat-bg);
      border-radius: 16px;
      padding: 18px 10px 12px 10px;
      box-shadow: var(--bubble-shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
      transition: box-shadow .3s, background .5s;
    }
    .message-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      position: relative;
    }
    .message-row.self { flex-direction: row-reverse; }
    .message-bubble {
      background: var(--bubble-other);
      padding: 11px 16px;
      border-radius: 20px 20px 6px 20px;
      font-size: 1.01rem;
      color: var(--text-main);
      position: relative;
      word-break: break-word;
      box-shadow: var(--bubble-shadow);
      animation: slideIn .35s;
      transition: background .15s, color .3s;
      min-width: 38px;
      max-width: 72vw;
    }
    .message-row.self .message-bubble {
      background: var(--bubble-me);
      border-radius: 20px 20px 20px 6px;
    }
    .message-meta {
      font-size: 0.78rem;
      color: var(--text-meta);
      margin: 0 5px;
      margin-top: 3px;
      display: flex;
      align-items: center;
      gap: 3px;
      justify-content: flex-end;
      transition: color .4s;
    }
    .delete-btn {
      background: none;
      border: none;
      color: #ff748b;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 5px;
      opacity: 0.7;
      transition: color .2s;
    }
    .delete-btn:hover { color: #e83a58; opacity: 1; }
    .chat-input-row {
      display: flex;
      gap: 5px;
      align-items: stretch;
      margin-top: 5px;
    }
    .chat-input-row input {
      flex: 1;
      border-radius: 14px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      padding: 11px 16px;
      font-size: 1.08rem;
      outline: none;
      transition: box-shadow .15s, background .5s, color .3s;
    }
    .chat-input-row input:focus { box-shadow: 0 2px 10px #43c6e4a2; }
    .send-btn {
      border: none;
      border-radius: 14px;
      font-size: 1.34rem;
      min-width: 48px;
      cursor: pointer;
      margin-left: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--btn-gradient);
      color: #fff;
      transition: background .2s, transform .12s;
    }
    .send-btn:hover { background: var(--btn-hover);}
    .version-info {
      text-align: center;
      color: #72e8b5;
      margin: 18px 0 9px 0;
      font-size: 1.04rem;
      letter-spacing: .5px;
      opacity: 0.90;
      font-weight: 500;
      text-shadow: 0 1px 1px #151b2490;
    }
    .chat-messages::-webkit-scrollbar {
      width: 9px;
      background: var(--scrollbar-track);
    }
    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 9px;
    }
    @media (max-width: 700px) {
      .chat-container, .login-container {
        padding: 16px 4vw 10px 4vw;
        max-width: 100vw;
        min-width: 0;
      }
      .chat-messages {
        height: 66vw; max-height: 68vw;
        min-height: 200px;
      }
      .chat-header img { width: 38px; height: 38px;}
    }
    @media (max-width: 480px) {
      .login-title { font-size: 1.2rem;}
      .chat-messages { padding: 11px 1px 6px 1px;}
    }
  </style>
</head>
<body>
  <!-- Tema Butonu (her iki ekranda da) -->
  <div class="theme-switch" id="themeSwitchBox">
    <input type="checkbox" id="themeToggle">
    <label class="switch-label" for="themeToggle">
      <span class="switch-icon sun" title="Açık Tema">☀️</span>
      <span class="switch-icon moon" title="Koyu Tema">🌙</span>
      <span class="switch-thumb"></span>
    </label>
  </div>

  <div class="login-container" id="loginContainer">
    <div class="login-title">Sohbet Giriş</div>
    <div class="login-fields">
      <input type="text" id="username" placeholder="Kullanıcı Adı" autocomplete="username" />
      <input type="password" id="password" placeholder="Şifre" autocomplete="current-password" />
      <button class="login-btn" id="loginBtn">Giriş Yap</button>
    </div>
    <div class="login-error" id="loginError"></div>
  </div>
  
  <div class="chat-container" id="chatContainer" style="display: none;">
    <div class="chat-header">
      <img id="profilePic" src="" alt="Profil Fotoğrafı">
      <div class="user-info-wrap">
        <span class="user-name" id="displayName"></span>
        <div class="status-list" id="statusList">
          <!-- Kullanıcı durumları JS ile buraya gelecek -->
        </div>
      </div>
      <button class="clear-btn" id="clearAllBtn" title="Tüm mesajları sil">🗑️</button>
      <button class="logout-btn" id="logoutBtn">Çıkış</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <form class="chat-input-row" id="messageForm" autocomplete="off">
      <input type="text" id="messageInput" maxlength="350" placeholder="Mesaj yaz..." />
      <button class="send-btn" type="submit">&#9658;</button>
    </form>
  </div>
  
  <div class="version-info">Sürüm: v14</div>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // --- Tema değiştirme ---
    const themeToggle = document.getElementById('themeToggle');
    const themeSwitchBox = document.getElementById('themeSwitchBox');
    // Animasyonlu başlatma, localStorage kaydı
    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeToggle.checked = (theme === 'light');
    }
    // Başlangıç teması: localStorage varsa oradan, yoksa otomatik
    (function(){
      let sysPref = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
      let savedTheme = localStorage.getItem('theme') || sysPref;
      setTheme(savedTheme);
    })();
    themeToggle.addEventListener('change', () => {
      setTheme(themeToggle.checked ? 'light' : 'dark');
      // Hafif animasyon için body'e class ekleyebilirsin
      document.body.classList.add('theme-switched');
      setTimeout(()=>document.body.classList.remove('theme-switched'),500);
    });

    // Tema butonunu her iki ekranda da görünür tutmak için:
    function fixThemeBtnZ() {
      let chatActive = chatContainer.style.display !== "none";
      themeSwitchBox.style.zIndex = chatActive ? "50" : "20";
    }

    // ---- Kullanıcı kodlama ve saklama ---
    function b64decode(str) {
      try {
        return decodeURIComponent(escape(atob(str)));
      } catch {
        return atob(str);
      }
    }
    function b64encode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }
    const userList = [
      {
        u: "ZXJlbnllbA==", // "erenyel"
        p: "MDUwN2VyZW4yMDAz", // "0507eren2003"
        name: "Eren Yel",
        pic: "https://raw.githubusercontent.com/erenyel/sohbet-sitesi/main/eren.png"
      },
      {
        u: "ZWRheW9udGVt", // "edayontem"
        p: "ZWRheTIwMDM=", // "eday2003"
        name: "Eda Yöntem",
        pic: "https://raw.githubusercontent.com/erenyel/sohbet-sitesi/main/eda.png"
      }
    ];
    const CLEAR_PW = "MTU5NzUz"; // "159753"

    // Firebase config (veritabanı URL'si)
    const firebaseConfig = {
      databaseURL: "https://sohbet-sitesi-2d0d8-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Kullanıcı oturumu
    let currentUser = null;
    let otherUser = null;

    // ELEMENTLER
    const loginContainer = document.getElementById('loginContainer');
    const chatContainer = document.getElementById('chatContainer');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const profilePic = document.getElementById('profilePic');
    const displayName = document.getElementById('displayName');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const messageForm = document.getElementById('messageForm');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const statusList = document.getElementById('statusList');

    function scrollToBottom() {
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 120);
    }

    // Kullanıcı adını şifreyi gizli şekilde kontrol et
    loginBtn.addEventListener('click', loginUser);
    passwordInput.addEventListener('keydown', (e) => { if (e.key === "Enter") loginUser(); });

    function loginUser() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      const uEnc = b64encode(username);
      const pEnc = b64encode(password);
      const found = userList.find(u => u.u === uEnc && u.p === pEnc);
      if (!found) {
        loginError.textContent = "Kullanıcı adı veya şifre yanlış!";
        return;
      }
      currentUser = {
        username: username,
        displayName: found.name,
        photoURL: found.pic
      };
      // Diğer kullanıcıyı bul
      const other = userList.find(u => u.u !== uEnc);
      otherUser = b64decode(other.u);
      // UI geçiş
      loginContainer.style.display = "none";
      chatContainer.style.display = "";
      profilePic.src = currentUser.photoURL;
      displayName.textContent = currentUser.displayName;
      loginError.textContent = "";
      messageInput.value = "";
      loadMessages();
      setOnline(true);
      monitorStatuses();
      scrollToBottom();
      window.addEventListener("beforeunload", () => setOnline(false));
      fixThemeBtnZ();
    }

    // Çıkış
    logoutBtn.addEventListener('click', () => {
      setOnline(false);
      location.reload();
    });

    // Son görülme & çevrimiçi durumu (her iki kullanıcıyı göster)
    let userStatuses = {};
    function setOnline(online) {
      if (!currentUser) return;
      db.ref("users/" + currentUser.username).set({
        online: online,
        lastSeen: online ? null : new Date().toISOString()
      });
    }

    // Her iki kullanıcının durumunu izle ve güncelle
    function monitorStatuses() {
      const allNames = userList.map(u => b64decode(u.u));
      allNames.forEach(name => {
        db.ref("users/" + name).on("value", snap => {
          userStatuses[name] = snap.val() || {};
          updateStatusList();
        });
      });
    }
    function updateStatusList() {
      // Sıra: önce giriş yapan (current), sonra diğer
      const all = [
        { 
          name: currentUser.username,
          display: currentUser.displayName,
        },
        { 
          name: otherUser,
          display: userList.find(u=>b64decode(u.u)===otherUser).name,
        }
      ];
      statusList.innerHTML = all.map(u => {
        const st = userStatuses[u.name] || {};
        let online = st.online;
        let txt = online ? "Çevrimiçi" : (st.lastSeen ? ("Son görülme: " + timeAgo(st.lastSeen)) : "");
        let cls = online ? "" : "offline";
        return `<span class="status-item ${cls}">
          <span class="status-dot"></span>
          <span class="status-user">${u.display}</span>
          <span class="status-text">${txt}</span>
        </span>`;
      }).join("");
    }

    function timeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.round((now - date) / 1000);
      if (diff < 60) return diff + " sn önce";
      if (diff < 3600) return Math.floor(diff / 60) + " dk önce";
      if (diff < 86400) return Math.floor(diff / 3600) + " sa önce";
      return date.toLocaleDateString('tr-TR') + " " + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    }

    // Mesajları yükle
    let firstLoad = true;
    function loadMessages() {
      db.ref("messages").off();
      chatMessages.innerHTML = `<div style="text-align:center;color:#94adc3;font-size:1.01rem;margin-top:15px">Yükleniyor...</div>`;
      db.ref("messages").on("value", snap => {
        chatMessages.innerHTML = "";
        const msgs = snap.val() || {};
        Object.entries(msgs).sort((a,b) => a[1].timestamp-b[1].timestamp).forEach(([msgId, msg]) => {
          const isMe = msg.sender === currentUser.username;
          chatMessages.appendChild(renderMessage(msg, msgId, isMe));
        });
        scrollToBottom();
        if (firstLoad) {
          firstLoad = false;
          setTimeout(scrollToBottom, 500);
        }
      });
    }

    function renderMessage(msg, msgId, isMe) {
      const row = document.createElement("div");
      row.className = "message-row" + (isMe ? " self" : "");
      // Kullanıcıyı userList'ten bul ve fotoğrafı getir
      const usr = userList.find(u => b64decode(u.u) === msg.sender);
      const avatar = document.createElement("img");
      avatar.src = usr ? usr.pic : "";
      avatar.alt = "Profil";
      avatar.style.width = "32px";
      avatar.style.height = "32px";
      avatar.style.borderRadius = "50%";
      avatar.style.border = "1.7px solid #349ecf";
      avatar.style.objectFit = "cover";
      row.appendChild(avatar);

      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.innerHTML = sanitize(msg.text);
      row.appendChild(bubble);

      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = formatTime(msg.timestamp);

      // Sadece kendi mesajını silebilir!
      if (isMe) {
        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.title = "Mesajı sil";
        delBtn.innerHTML = "&#128465;";
        delBtn.onclick = () => {
          if (confirm("Bu mesajı silmek istiyor musun?")) {
            db.ref("messages/" + msgId).remove();
          }
        };
        meta.appendChild(delBtn);
      }

      bubble.appendChild(meta);
      return row;
    }

    function sanitize(str) {
      return str
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\n/g, "<br>");
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    }

    // Mesaj gönderme
    messageForm.addEventListener("submit", e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      db.ref("messages").push({
        sender: currentUser.username,
        text,
        timestamp: Date.now()
      });
      messageInput.value = "";
      messageInput.focus();
      scrollToBottom();
    });

    // Tüm mesajları sil (şifreyle, şifre gizli tutuluyor)
    clearAllBtn.addEventListener('click', () => {
      const pw = prompt("Tüm mesajları silmek için şifreyi giriniz:");
      if (pw && b64encode(pw) === CLEAR_PW) {
        if(confirm("Tüm mesajları silmek istediğine emin misin? Bu işlem geri alınamaz.")) {
          db.ref("messages").remove();
          setTimeout(scrollToBottom, 500);
        }
      } else if (pw !== null) {
        alert("Şifre hatalı!");
      }
    });

    messageInput.addEventListener("focus", scrollToBottom);
    setInterval(() => { if (currentUser) setOnline(true); }, 20000);
    window.onload = () => { usernameInput.focus(); fixThemeBtnZ(); }
  </script>
</body>
</html>
