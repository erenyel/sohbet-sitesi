<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sohbet Sitesi v15</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-bg: #222937;
      --primary-bg-gradient: linear-gradient(120deg, #222937 0%, #37425a 100%);
      --chat-bg: #151b24;
      --bubble-me: linear-gradient(125deg, #0f8ecf 0%, #2560a7 100%);
      --bubble-other: linear-gradient(120deg, #343e53 0%, #45516a 100%);
      --header: #222937;
      --input-bg: #232a3b;
      --input-border: #3a4258;
      --btn-gradient: linear-gradient(90deg, #329dba 30%, #4569ad 100%);
      --btn-hover: #276b8d;
      --emoji-btn-bg: #232a3b;
      --emoji-btn-color: #85e1e6;
      --scrollbar-thumb: #394a64;
      --scrollbar-track: #20242e;
      --text-main: #eaf4ff;
      --text-meta: #8aa3c8;
      --text-online: #72e8b5;
      --bubble-shadow: 0 2px 12px #242e3855;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--primary-bg-gradient);
      font-family: 'Montserrat', sans-serif;
      min-height: 100vh;
      color: var(--text-main);
      display: flex;
      flex-direction: column;
    }
    .login-container, .chat-container {
      max-width: 420px;
      width: 95vw;
      margin: 32px auto 0 auto;
      background: rgba(34,41,55,0.97);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(44,72,100,0.24);
      padding: 28px 18px 18px 18px;
      animation: fadeIn .8s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(16px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .login-title {
      font-size: 2rem;
      font-weight: 700;
      color: #84fff9;
      text-align: center;
      margin-bottom: 24px;
      letter-spacing: 1px;
      text-shadow: 0 1px 8px #15294090;
    }
    .login-fields {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .login-fields input {
      padding: 12px 14px;
      border-radius: 9px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 1rem;
      transition: box-shadow .2s;
      outline: none;
    }
    .login-fields input:focus {
      box-shadow: 0 2px 12px #43c6e4a2;
    }
    .login-btn {
      margin-top: 16px;
      background: var(--btn-gradient);
      color: #fff;
      font-size: 1.13rem;
      font-weight: bold;
      padding: 11px 0;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      letter-spacing: .5px;
      transition: background .2s, transform .1s;
      box-shadow: 0 2px 8px #124e6788;
    }
    .login-btn:hover { background: var(--btn-hover); transform: scale(1.03);}
    .login-error {
      color: #ff5e75;
      text-align: center;
      margin-top: 12px;
      font-size: 1rem;
    }
    /* Chat container styles */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid #293448;
      background: var(--header);
      border-radius: 18px 18px 0 0;
      box-shadow: 0 2px 8px #151b2417;
    }
    .chat-header img {
      width: 48px; height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2.5px solid #74ebd5;
    }
    .chat-header .user-info {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .chat-header .user-name {
      font-size: 1.1rem;
      font-weight: bold;
      color: #b3e9ff;
      text-shadow: 0 1px 6px #15294060;
    }
    .chat-header .user-status {
      font-size: 0.98rem;
      color: var(--text-online);
      font-weight: 500;
      min-height: 18px;
      text-shadow: 0 1px 5px #23333c8c;
    }
    .logout-btn, .clear-btn {
      margin-left: 8px;
      padding: 7px 16px;
      font-size: 0.99rem;
      border: none;
      border-radius: 8px;
      background: #1d2535;
      color: #72e8b5;
      cursor: pointer;
      transition: background .2s;
    }
    .logout-btn:hover, .clear-btn:hover { background: #293348; }
    .chat-messages {
      margin: 12px 0;
      height: 380px;
      max-height: 55vh;
      overflow-y: auto;
      background: var(--chat-bg);
      border-radius: 16px;
      padding: 18px 10px 12px 10px;
      box-shadow: var(--bubble-shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
      transition: box-shadow .3s;
    }
    .message-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      position: relative;
    }
    .message-row.self { flex-direction: row-reverse; }
    .message-bubble {
      background: var(--bubble-other);
      padding: 11px 16px;
      border-radius: 20px 20px 6px 20px;
      font-size: 1.01rem;
      color: var(--text-main);
      position: relative;
      word-break: break-word;
      box-shadow: var(--bubble-shadow);
      animation: slideIn .35s;
      transition: background .15s;
      min-width: 38px;
      max-width: 72vw;
    }
    .message-row.self .message-bubble {
      background: var(--bubble-me);
      border-radius: 20px 20px 20px 6px;
    }
    .message-meta {
      font-size: 0.78rem;
      color: var(--text-meta);
      margin: 0 5px;
      margin-top: 3px;
      display: flex;
      align-items: center;
      gap: 3px;
      justify-content: flex-end;
    }
    .delete-btn {
      background: none;
      border: none;
      color: #ff748b;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 5px;
      opacity: 0.7;
      transition: color .2s;
    }
    .delete-btn:hover { color: #e83a58; opacity: 1; }
    .chat-input-row {
      display: flex;
      gap: 5px;
      align-items: stretch;
      margin-top: 5px;
    }
    .chat-input-row input {
      flex: 1;
      border-radius: 14px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      padding: 11px 16px;
      font-size: 1.08rem;
      outline: none;
      transition: box-shadow .15s;
    }
    .chat-input-row input:focus { box-shadow: 0 2px 10px #43c6e4a2; }
    .send-btn {
      border: none;
      border-radius: 14px;
      font-size: 1.34rem;
      min-width: 48px;
      cursor: pointer;
      margin-left: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--btn-gradient);
      color: #fff;
      transition: background .2s, transform .12s;
    }
    .send-btn:hover { background: var(--btn-hover);}
    .version-info {
      text-align: center;
      color: #72e8b5;
      margin: 18px 0 9px 0;
      font-size: 1.04rem;
      letter-spacing: .5px;
      opacity: 0.90;
      font-weight: 500;
      text-shadow: 0 1px 1px #151b2490;
    }
    .chat-messages::-webkit-scrollbar {
      width: 9px;
      background: var(--scrollbar-track);
    }
    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 9px;
    }
    @media (max-width: 700px) {
      .chat-container, .login-container {
        padding: 16px 4vw 10px 4vw;
        max-width: 100vw;
        min-width: 0;
      }
      .chat-messages {
        height: 66vw; max-height: 68vw;
        min-height: 200px;
      }
      .chat-header img { width: 40px; height: 40px;}
    }
    @media (max-width: 480px) {
      .login-title { font-size: 1.2rem;}
      .chat-messages { padding: 11px 1px 6px 1px;}
    }
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <div class="login-title">Sohbet Giri≈ü</div>
    <div class="login-fields">
      <input type="text" id="username" placeholder="Kullanƒ±cƒ± Adƒ±" autocomplete="username" />
      <input type="password" id="password" placeholder="≈ûifre" autocomplete="current-password" />
      <button class="login-btn" id="loginBtn">Giri≈ü Yap</button>
    </div>
    <div class="login-error" id="loginError"></div>
  </div>
  
  <div class="chat-container" id="chatContainer" style="display: none;">
    <div class="chat-header">
      <img id="profilePic" src="" alt="Profil Fotoƒürafƒ±">
      <div class="user-info">
        <span class="user-name" id="displayName"></span>
        <span class="user-status" id="onlineStatus"></span>
      </div>
      <button class="clear-btn" id="clearAllBtn" title="T√ºm mesajlarƒ± sil">üóëÔ∏è</button>
      <button class="logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <form class="chat-input-row" id="messageForm" autocomplete="off">
      <input type="text" id="messageInput" maxlength="350" placeholder="Mesaj yaz..." />
      <button class="send-btn" type="submit">&#9658;</button>
    </form>
  </div>
  
  <div class="version-info">S√ºr√ºm: v15</div>
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // Yardƒ±mcƒ± kodlama fonksiyonlarƒ±
    function b64decode(str) {
      try {
        return decodeURIComponent(escape(atob(str)));
      } catch {
        return atob(str);
      }
    }
    function b64encode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    // Kullanƒ±cƒ± bilgileri base64'l√º liste (ad, ≈üifre, isim, foto url)
    const userList = [
      {
        u: "ZXJlbnllbA==", // "erenyel"
        p: "MDUwN2VyZW4yMDAz", // "0507eren2003"
        name: "Eren Yel",
        pic: "https://raw.githubusercontent.com/erenyel/sohbet-sitesi/main/eren.png"
      },
      {
        u: "ZWRheW9udGVt", // "edayontem"
        p: "ZWRheTIwMDM=", // "eday2003"
        name: "Eda Y√∂ntem",
        pic: "https://raw.githubusercontent.com/erenyel/sohbet-sitesi/main/eda.png"
      }
    ];

    // Mesajlarƒ± silme ≈üifresi (yine base64 ile saklƒ±)
    const CLEAR_PW = "MTU5NzUz"; // "159753"

    // Firebase config (veritabanƒ± URL'si)
    const firebaseConfig = {
      databaseURL: "https://sohbet-sitesi-2d0d8-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Kullanƒ±cƒ± oturumu
    let currentUser = null;
    let otherUser = null;

    // ELEMENTLER
    const loginContainer = document.getElementById('loginContainer');
    const chatContainer = document.getElementById('chatContainer');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const profilePic = document.getElementById('profilePic');
    const displayName = document.getElementById('displayName');
    const onlineStatus = document.getElementById('onlineStatus');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const messageForm = document.getElementById('messageForm');
    const clearAllBtn = document.getElementById('clearAllBtn');

    // Mesajlarƒ± kaydƒ±rma fonksiyonu
    function scrollToBottom() {
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 120);
    }

    // Kullanƒ±cƒ± adƒ±nƒ± ≈üifreyi gizli ≈üekilde kontrol et
    loginBtn.addEventListener('click', loginUser);
    passwordInput.addEventListener('keydown', (e) => { if (e.key === "Enter") loginUser(); });

    function loginUser() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      // Base64 encode edilmi≈ü hali ile kar≈üƒ±la≈ütƒ±r
      const uEnc = b64encode(username);
      const pEnc = b64encode(password);
      const found = userList.find(u => u.u === uEnc && u.p === pEnc);
      if (!found) {
        loginError.textContent = "Kullanƒ±cƒ± adƒ± veya ≈üifre yanlƒ±≈ü!";
        return;
      }
      currentUser = {
        username: username,
        displayName: found.name,
        photoURL: found.pic
      };
      // Diƒüer kullanƒ±cƒ±yƒ± bul
      const other = userList.find(u => u.u !== uEnc);
      otherUser = b64decode(other.u);
      // UI ge√ßi≈ü
      loginContainer.style.display = "none";
      chatContainer.style.display = "";
      profilePic.src = currentUser.photoURL;
      displayName.textContent = currentUser.displayName;
      loginError.textContent = "";
      messageInput.value = "";
      loadMessages();
      setOnline(true);
      monitorOtherUserStatus();
      scrollToBottom();
      window.addEventListener("beforeunload", () => setOnline(false));
    }

    // √áƒ±kƒ±≈ü
    logoutBtn.addEventListener('click', () => {
      setOnline(false);
      location.reload();
    });

    // Son g√∂r√ºlme & √ßevrimi√ßi durumu
    function setOnline(online) {
      if (!currentUser) return;
      db.ref("users/" + currentUser.username).set({
        online: online,
        lastSeen: online ? null : new Date().toISOString()
      });
    }

    function monitorOtherUserStatus() {
      db.ref("users/" + otherUser).on("value", snap => {
        const data = snap.val();
        if (data && data.online) {
          onlineStatus.textContent = "√áevrimi√ßi";
          onlineStatus.style.color = "#72e8b5";
        } else if (data && data.lastSeen) {
          onlineStatus.textContent = "Son g√∂r√ºlme: " + timeAgo(data.lastSeen);
          onlineStatus.style.color = "#8aa3c8";
        } else {
          onlineStatus.textContent = "";
        }
      });
    }

    function timeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = Math.round((now - date) / 1000);
      if (diff < 60) return diff + " sn √∂nce";
      if (diff < 3600) return Math.floor(diff / 60) + " dk √∂nce";
      if (diff < 86400) return Math.floor(diff / 3600) + " sa √∂nce";
      return date.toLocaleDateString('tr-TR') + " " + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    }

    // Mesajlarƒ± y√ºkle
    let firstLoad = true;
    function loadMessages() {
      db.ref("messages").off();
      chatMessages.innerHTML = `<div style="text-align:center;color:#94adc3;font-size:1.01rem;margin-top:15px">Y√ºkleniyor...</div>`;
      db.ref("messages").on("value", snap => {
        chatMessages.innerHTML = "";
        const msgs = snap.val() || {};
        Object.entries(msgs).sort((a,b) => a[1].timestamp-b[1].timestamp).forEach(([msgId, msg]) => {
          const isMe = msg.sender === currentUser.username;
          chatMessages.appendChild(renderMessage(msg, msgId, isMe));
        });
        scrollToBottom();
        if (firstLoad) {
          firstLoad = false;
          setTimeout(scrollToBottom, 500);
        }
      });
    }

    function renderMessage(msg, msgId, isMe) {
      const row = document.createElement("div");
      row.className = "message-row" + (isMe ? " self" : "");
      // Kullanƒ±cƒ±yƒ± userList'ten bul ve fotoƒürafƒ± getir
      const usr = userList.find(u => b64decode(u.u) === msg.sender);
      const avatar = document.createElement("img");
      avatar.src = usr ? usr.pic : "";
      avatar.alt = "Profil";
      avatar.style.width = "32px";
      avatar.style.height = "32px";
      avatar.style.borderRadius = "50%";
      avatar.style.border = "1.7px solid #349ecf";
      avatar.style.objectFit = "cover";
      row.appendChild(avatar);

      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.innerHTML = sanitize(msg.text);
      row.appendChild(bubble);

      const meta = document.createElement("div");
      meta.className = "message-meta";
      meta.textContent = formatTime(msg.timestamp);

      // Sadece kendi mesajƒ±nƒ± silebilir!
      if (isMe) {
        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.title = "Mesajƒ± sil";
        delBtn.innerHTML = "&#128465;";
        delBtn.onclick = () => {
          if (confirm("Bu mesajƒ± silmek istiyor musun?")) {
            db.ref("messages/" + msgId).remove();
          }
        };
        meta.appendChild(delBtn);
      }

      bubble.appendChild(meta);
      return row;
    }

    function sanitize(str) {
      return str
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\n/g, "<br>");
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    }

    // Mesaj g√∂nderme
    messageForm.addEventListener("submit", e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      db.ref("messages").push({
        sender: currentUser.username,
        text,
        timestamp: Date.now()
      });
      messageInput.value = "";
      messageInput.focus();
      scrollToBottom();
    });

    // T√ºm mesajlarƒ± sil (≈üifreyle, ≈üifre gizli tutuluyor)
    clearAllBtn.addEventListener('click', () => {
      const pw = prompt("T√ºm mesajlarƒ± silmek i√ßin ≈üifreyi giriniz:");
      if (pw && b64encode(pw) === CLEAR_PW) {
        if(confirm("T√ºm mesajlarƒ± silmek istediƒüine emin misin? Bu i≈ülem geri alƒ±namaz.")) {
          db.ref("messages").remove();
          setTimeout(scrollToBottom, 500);
        }
      } else if (pw !== null) {
        alert("≈ûifre hatalƒ±!");
      }
    });

    messageInput.addEventListener("focus", scrollToBottom);
    setInterval(() => { if (currentUser) setOnline(true); }, 20000);
    window.onload = () => { usernameInput.focus(); }
  </script>
</body>
</html>
